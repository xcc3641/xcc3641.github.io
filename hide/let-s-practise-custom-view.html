<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Android 初阶自定义 View 字符头像 · IM XIE</title><meta name="description" content="Android 初阶自定义 View 字符头像 - 谢三弟"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://imxie.cc/atom.xml" title="IM XIE"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/images/logo.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/xcc3641" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/WebLab/" target="_self" class="nav-list-link">WEBLAB</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Android 初阶自定义 View 字符头像</h1><div class="post-info">2016年9月14日</div><div class="post-content"><p>自己很少做自定义 View ，只有最开始的时候跟着郭神写了一个小 Demo ，后来随着见识的越来越多，特别是在开源社区看到很多优秀的漂亮的控件，都是羡慕的要死，但是拉下来的代码还是看不明白，而且当时因为时间因素，没有深入学习和研究控件和动画方面的知识，而是把更多时间花在了 Android 的异步通信和网络框架这一块。<br>因为想起暑假实习的时候有个小需求，当时因为忙着主要的业务，一直搁浅没有做，回到学校发现其实不难。索性从这个人生第一个上架的小控件慢慢深入一点，顺带复习 View 的绘制原理。</p>
<a id="more"></a>
<blockquote>
<ul>
<li>文章来源：itsCoder 的 <a href="https://github.com/itsCoder/weeklyblog" target="_blank" rel="external">WeeklyBolg</a> 项目</li>
<li>itsCoder主页：<a href="http://itscoder.com/" target="_blank" rel="external">http://itscoder.com/</a></li>
<li>作者：<a href="https://github.com/xcc3641" target="_blank" rel="external">谢三弟</a></li>
<li>审阅者：<a href="https://github.com/brucezz" target="_blank" rel="external">Brucezz</a></li>
</ul>
</blockquote>
<h3 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h3><ul>
<li><a href="#目录">目录</a></li>
<li><a href="#目标效果">目标效果</a></li>
<li><a href="#继承-ImageView-开始">继承 ImageView 开始</a></li>
<li><a href="#工作流程">工作流程</a><ul>
<li><a href="#onMeasure">onMeasure()</a></li>
<li><a href="#onLayout">onLayout()</a></li>
<li><a href="#onDraw">onDraw()</a></li>
</ul>
</li>
<li><a href="#使用">使用</a></li>
<li><a href="#额外阅读">额外阅读</a></li>
</ul>
<h3 id="目标效果"><a href="#目标效果" class="headerlink" title="目标效果"></a>目标效果</h3><blockquote>
<p>需求：实习公司一个产品，因为很多是临时用户，需要为这些没有自觉设置头像的用户，给予随机头像。生成的规则是根据用户用户名的第一个字符随机匹配颜色集。</p>
</blockquote>
<p>从需求中我们可以知道：</p>
<ul>
<li>该控件需要展示图片</li>
<li>该控件需要按照规则生成图像</li>
<li>一般头像都是圆形</li>
</ul>
<p><img src="http://ww3.sinaimg.cn/large/801b780agw1f7ugm27t4oj205m05agll.jpg" alt=""></p>
<p>大致上可以知道是这样的。<br>开搞！</p>
<h3 id="继承-ImageView-开始"><a href="#继承-ImageView-开始" class="headerlink" title="继承 ImageView 开始"></a>继承 ImageView 开始</h3><p>我们都知道 Android 自带了很多控件，我们自定义控件的出发点只是官方提供的控件无法满足业务需求的时候。<br>从我们的需求来看，该控件是图片展示类的，所以我们很自然想到了只需要在系统 ImageView 上进行功能拓展即可，这样就可以满足新的需求又不会失去 ImageView 自带的功能。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CharAvatarView</span> <span class="keyword">extends</span> <span class="title">ImageView</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = CharAvatarView.class.getSimpleName();</div><div class="line">    <span class="comment">// 颜色画板集</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>[] colors = &#123;</div><div class="line">        <span class="number">0xff1abc9c</span>, <span class="number">0xff16a085</span>, <span class="number">0xfff1c40f</span>, <span class="number">0xfff39c12</span>, <span class="number">0xff2ecc71</span>,</div><div class="line">        <span class="number">0xff27ae60</span>, <span class="number">0xffe67e22</span>, <span class="number">0xffd35400</span>, <span class="number">0xff3498db</span>, <span class="number">0xff2980b9</span>,</div><div class="line">        <span class="number">0xffe74c3c</span>, <span class="number">0xffc0392b</span>, <span class="number">0xff9b59b6</span>, <span class="number">0xff8e44ad</span>, <span class="number">0xffbdc3c7</span>,</div><div class="line">        <span class="number">0xff34495e</span>, <span class="number">0xff2c3e50</span>, <span class="number">0xff95a5a6</span>, <span class="number">0xff7f8c8d</span>, <span class="number">0xffec87bf</span>,</div><div class="line">        <span class="number">0xffd870ad</span>, <span class="number">0xfff69785</span>, <span class="number">0xff9ba37e</span>, <span class="number">0xffb49255</span>, <span class="number">0xffb49255</span>, <span class="number">0xffa94136</span></div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Paint mPaintBackground;</div><div class="line">    <span class="keyword">private</span> Paint mPaintText;</div><div class="line">    <span class="keyword">private</span> Rect mRect;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String text;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> charHash;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CharAvatarView</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CharAvatarView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(context, attrs, <span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CharAvatarView</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</div><div class="line">        init();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        mPaintBackground = <span class="keyword">new</span> Paint(Paint.ANTI_ALIAS_FLAG);</div><div class="line">        mPaintText = <span class="keyword">new</span> Paint(Paint.ANTI_ALIAS_FLAG);</div><div class="line">        mRect = <span class="keyword">new</span> Rect();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这里我做了一些初始化工作，并且在其中的一个构造函数中实例化了 <code>Paint</code> 和 <code>Rect</code> 。</p>
<p>关于 View 的构造函数的区别：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">CharAvatarView</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(context);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">CharAvatarView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(context, attrs);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">CharAvatarView</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(context, attrs, defStyleAttr);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>第一种属于程序内实例化时采用，之传入 Context 即可<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">CharAvatarView avatarView = <span class="keyword">new</span> CharAvatarView(<span class="keyword">this</span>);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>这样我们的 View 就新建出来了，根据需求添加到布局即可。</p>
<ul>
<li><p>第二种用于 layout 文件实例化，会把 XML 内的参数通过 AttributeSet 带入到 View 内。</p>
</li>
<li><p>第三个主题的 style 信息，也会从 XML 里带入</p>
</li>
</ul>
<p>为了自定义的 View 兼容 Java 和 Xml 两种代码的使用方式，一般推荐这样写构造方法：<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">CharAvatarView</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">      <span class="keyword">this</span>(context, <span class="keyword">null</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">CharAvatarView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">      <span class="keyword">this</span>(context, attrs, <span class="number">0</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">CharAvatarView</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</div><div class="line">      <span class="keyword">super</span>(context, attrs, defStyleAttr);</div><div class="line">      init();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">      mPaintBackground = <span class="keyword">new</span> Paint(Paint.ANTI_ALIAS_FLAG);</div><div class="line">      mPaintText = <span class="keyword">new</span> Paint(Paint.ANTI_ALIAS_FLAG);</div><div class="line">      mRect = <span class="keyword">new</span> Rect();</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<h3 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h3><p>我们的 View 系统是如何将它绘制到屏幕上的呢？</p>
<blockquote>
<p>View 的绘制流程是从 ViewRoot 的 <code>performTraversals</code> 方法开始，它经过 measure 、 layout 和 draw 三个过程才能最终将一个 View 绘制出来，其中 measure 用来测量 View 的宽和高，layout 用来确定 View 在父容器中的放置位置，而 draw 则负责将 View 绘制在屏幕上。针对 performTraversals 的大致流程如图：</p>
</blockquote>
<p><img src="http://ww4.sinaimg.cn/large/801b780agw1f7um4igvkcj20up0imta0.jpg" alt=""></p>
<blockquote>
<p>Measure 过程决定了 View 的宽/高， Measure 完成以后，可以通过 <code>getMeasuredWidth</code> 和 <code>getMeasuredHeight</code> 方法来获取到 View 测量后的宽/高，在几乎所有的情况下它都等同于 View 最终的宽/高，但是特殊情况除外。<br>Layout 过程 决定了 View 的四个顶点的坐标和实际的 View 的宽/高，完成以后，可以通过 <code>getTop</code>、<code>getBottom</code>、<code>getLeft</code>、<code>getRight</code> 来拿到 View 的四个顶点的位置，并可以通过 <code>getWidth</code> 和 <code>getHeight</code> 方法拿到 View 最终的宽/高。<br>Draw 过程则决定了 View 的显示，只有 draw 方法完成以后 View 的内容才能呈现在屏幕上。</p>
</blockquote>
<p>关于 View 工作流程的深入我们在以后另外开篇进行研究。目前我们已经从宏观了解到了 View 会经历三个过程绘制出来，而且清楚了其中不同方法中的用途。接下来我们看看 CharAvatarView 在这三个流程中分别做了什么。</p>
<h4 id="onMeasure"><a href="#onMeasure" class="headerlink" title="onMeasure()"></a>onMeasure()</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onMeasure(widthMeasureSpec, widthMeasureSpec); <span class="comment">// 宽高相同</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>让宽高相同，我在这里是只直接传入宽度进行测量。<br>这样会得到一个正方形的 View。</p>
<h4 id="onLayout"><a href="#onLayout" class="headerlink" title="onLayout()"></a>onLayout()</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onLayout(changed, left, top, right, bottom);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我在这里什么也没有做，因为需求里对 View 的位置没有什么需要特殊的处理。</p>
<h4 id="onDraw"><a href="#onDraw" class="headerlink" title="onDraw()"></a>onDraw()</h4><p>大部分自定义控件，最核心的代码就是在 <code>onDraw()</code> 里了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onDraw(canvas);</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != text) &#123;</div><div class="line">        <span class="keyword">int</span> color = colors[charHash % colors.length];</div><div class="line">        <span class="comment">// 画圆</span></div><div class="line">        mPaintBackground.setColor(color);</div><div class="line">        canvas.drawCircle(getWidth() / <span class="number">2</span>, getWidth() / <span class="number">2</span>, getWidth() / <span class="number">2</span>, mPaintBackground);</div><div class="line">        <span class="comment">// 写字</span></div><div class="line">        mPaintText.setColor(Color.WHITE);</div><div class="line">        mPaintText.setTextSize(getWidth() / <span class="number">2</span>);</div><div class="line">        mPaintText.setStrokeWidth(<span class="number">3</span>);</div><div class="line">        mPaintText.getTextBounds(text, <span class="number">0</span>, <span class="number">1</span>, mRect);</div><div class="line">        <span class="comment">// 垂直居中</span></div><div class="line">        Paint.FontMetricsInt fontMetrics = mPaintText.getFontMetricsInt();</div><div class="line">        <span class="keyword">int</span> baseline = (getMeasuredHeight() - fontMetrics.bottom - fontMetrics.top) / <span class="number">2</span>;</div><div class="line">        <span class="comment">// 左右居中</span></div><div class="line">        mPaintText.setTextAlign(Paint.Align.CENTER);</div><div class="line">        canvas.drawText(text, getWidth() / <span class="number">2</span>, baseline, mPaintText);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>首先从颜色数组里根据 hash 取余得到背景颜色</li>
<li>然后画出背景圆</li>
<li>接下来就是写字</li>
<li>最后是对字居中的处理</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> content 传入字符内容</span></div><div class="line"><span class="comment"> * 只会取内容的第一个字符,如果是字母转换成大写</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setText</span><span class="params">(String content)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (content == <span class="keyword">null</span>) &#123;</div><div class="line">        content=<span class="string">" "</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.text = String.valueOf(content.toCharArray()[<span class="number">0</span>]);</div><div class="line">    <span class="keyword">this</span>.text = text.toUpperCase();</div><div class="line">    charHash = <span class="keyword">this</span>.text.hashCode();</div><div class="line">    <span class="comment">// 重绘</span></div><div class="line">    invalidate();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这是暴露给外部的方法，我们也是在这里得到要画的字符。</p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>在 gradle 依赖里添加:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">compile <span class="string">'com.github.xcc3641:charavatarview:0.1'</span></div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">com.hugo.charavatarview.CharAvatarView</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"50dp"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"50dp"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">"@+id/avatar"</span>/&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">CharAvatarView mAvatarView;</div><div class="line">mAvatarView = (CharAvatarView) findViewById(R.id.avatar);</div><div class="line">mAvatarView.setText(<span class="string">"谢三弟"</span>);</div></pre></td></tr></table></figure>
<p>运行：<br><img src="http://ww4.sinaimg.cn/large/801b780agw1f7upxsczbsj20p815egnp.jpg" alt=""></p>
<p>人生第一个自定义 View 就完成了。</p>
<p>上传到可以参考司机的这篇文章<a href="">码农必知之上传开源库到 jcenter</a>，配置好各种参数。以后更新版本就执行一行代码就行啦。</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><div class="line">.<span class="regexp">/gradlew install /</span><span class="regexp">/ 只需要第一次执行</span></div><div class="line"><span class="regexp">./g</span>radlew bintrayUpload</div></pre></td></tr></table></figure>
<p>开源地址：<a href="https://github.com/xcc3641/CharAvatarView" target="_blank" rel="external">GitHub 地址</a></p>
<h3 id="额外阅读"><a href="#额外阅读" class="headerlink" title="额外阅读"></a>额外阅读</h3><ul>
<li><a href="http://www.cnblogs.com/tianzhijiexian/p/4300988.html" target="_blank" rel="external">讲解 Canvas 中的一些重要方法</a></li>
<li><a href="http://www.jianshu.com/p/d507e3514b65" target="_blank" rel="external">教你步步为营掌握自定义 View</a></li>
</ul></div></article></div></section><footer><div class="paginator"></div><div data-thread-key="hide/let-s-practise-custom-view.html" data-title="Android 初阶自定义 View 字符头像" data-url="http://imxie.cc/hide/let-s-practise-custom-view.html" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"imxie"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = 'http://www.imxie.cc/js/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2014 - 2019 做一件值得的事.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-80145821-1",'auto');ga('send','pageview');</script></body></html>