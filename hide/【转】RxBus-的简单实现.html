<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 【转】RxBus 的简单实现 · IM XIE</title><meta name="description" content="【转】RxBus 的简单实现 - 谢三弟"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://imxie.cc/atom.xml" title="IM XIE"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/images/logo.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/xcc3641" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">【转】RxBus 的简单实现</h1><div class="post-info">2016年6月2日</div><div class="post-content"><blockquote>
<p>这篇转自 <a href="http://brucezz.github.io/" target="_blank" rel="external">brucezz</a></p>
</blockquote>
<p>今天写代码正好想到要用事件总线，先前都是使用 Square 的 Otto 或者 GreenRobot 的 EventBus ，听说 RxJava 能够轻易实现一个 Bus，所以就来研究研究这个车怎么开~</p>
<a id="more"></a>
<p><img src="http://brucezz.github.io/images/no-time-to-explain.jpg" alt="没时间解释了，快上车！"></p>
<p>这辆车需要有一下功能：</p>
<ul>
<li>订阅者能够订阅某种事件 Event</li>
<li>发布某种 Event 时，该事件的订阅者们能够及时响应</li>
</ul>
<p>在 RxJava 里有一个对象 Subject，既是 Observable 又是 Observer，可以把 Subject 理解成一个管道或者转发器，数据从一端输入，然后从另一端输出。</p>
<p>Subject 有好几种，这里可以使用最简单的 <code>PublishSubject</code>。一旦数据从一端传入，结果会里立刻从另一端输出。</p>
<p>由于允许订阅者订阅某一种类型的 Event，所以注册订阅的时候需要一个 Class 对象对事件进行过滤。</p>
<h3 id="简单实现"><a href="#简单实现" class="headerlink" title="简单实现"></a>简单实现</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RxBus</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> RxBus instance;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Subject&lt;Object, Object&gt; BUS;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">RxBus</span><span class="params">()</span> </span>&#123;</div><div class="line">        BUS = <span class="keyword">new</span> SerializedSubject&lt;&gt;(PublishSubject.create());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RxBus <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (RxBus.class) &#123;</div><div class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</div><div class="line">                    instance = <span class="keyword">new</span> RxBus();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> instance;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">(Object event)</span> </span>&#123;</div><div class="line">        BUS.onNext(event);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">toObserverable</span><span class="params">(Class&lt;T&gt; eventType)</span> </span>&#123;</div><div class="line">        <span class="comment">// ofType = filter + cast</span></div><div class="line">        <span class="keyword">return</span> BUS.ofType(eventType);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中，RxBus 使用了单例模式，确保应用中只有一辆车。</p>
<p><code>post</code> 方法发布一个 Event 对象给 bus，然后由 bus 转发给订阅者们。</p>
<p><code>toObserverable</code> 方法能够获得一个包含目标事件的 Observable，订阅者对其订阅即可响应。</p>
<p><code>bus.ofType()</code> 等效于  <code>bus.filter(eventType::isInstance).cast(eventType)</code> ，即先过滤事件类型，然后发射给订阅者。</p>
<h3 id="开车啦"><a href="#开车啦" class="headerlink" title="开车啦"></a>开车啦</h3><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RxBusActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> CompositeSubscription allSubscription = <span class="keyword">new</span> CompositeSubscription();</div><div class="line">    Button send;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        send = (Button) findViewById(R.id.send);</div><div class="line">        send.setOnClickListener(</div><div class="line">                v -&gt; RxBus.getDefault().post(<span class="keyword">new</span> OneEvent(<span class="string">"hello bus"</span>)));</div><div class="line">        allSubscription.add(RxBus.getDefault()</div><div class="line">                .toObserverable(OneEvent.class).subscribe(<span class="keyword">this</span>::response));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">response</span><span class="params">(OneEvent event)</span> </span>&#123;</div><div class="line">        ToastUtil.show(event.msg);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">        <span class="keyword">if</span> (allSubscription != <span class="keyword">null</span> &amp;&amp; !allSubscription.isUnsubscribed())</div><div class="line">            allSubscription.unsubscribe();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">OneEvent</span> </span>&#123;</div><div class="line">        <span class="comment">// some data you need ...</span></div><div class="line">        String msg;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">OneEvent</span><span class="params">(String msg)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.msg = msg;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>点击按钮，发送  <code>OneEvent</code> 事件，然后响应此事件，发出 Toast ~</p>
<p>通过多次调用 <code>toObserverable()</code> 方法可以订阅多种事件。</p>
<p><strong>小 tip</strong> : <code>CompositeSubscription</code> 可以把 Subscription 收集到一起，方便 Activity 销毁时取消订阅，防止内存泄漏。</p>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><ul>
<li><a href="https://drakeet.me/rxbus" target="_blank" rel="external">翻译：通过 RxJava 实现一个 Event Bus – RxBus | Drakeet的个人博客</a></li>
<li><a href="http://www.jianshu.com/p/ca090f6e2fe2/" target="_blank" rel="external">用RxJava实现事件总线(Event Bus) - 简书</a></li>
</ul></div></article></div></section><footer><div class="paginator"></div><div data-thread-key="hide/【转】RxBus-的简单实现.html" data-title="【转】RxBus 的简单实现" data-url="http://imxie.cc/hide/【转】RxBus-的简单实现.html" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"imxie"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = 'http://www.imxie.cc/js/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2014 - 2019 做一件值得的事.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-80145821-1",'auto');ga('send','pageview');</script></body></html>