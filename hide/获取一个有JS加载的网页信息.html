<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 获取一个有JS加载的网页信息 · IM XIE</title><meta name="description" content="获取一个有JS加载的网页信息 - 谢三弟"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://imxie.cc/atom.xml" title="IM XIE"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/xcc3641" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/WebLab/" target="_self" class="nav-list-link">WEBLAB</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">获取一个有JS加载的网页信息</h1><div class="post-info">2015年12月26日</div><div class="post-content"><p>现在很多网页内容是通过JS加载出来的，而不是静态不变的。本文以<a href="http://pp.163.com/pp/#p=10&amp;c=-1&amp;m=3&amp;page=1" target="_blank" rel="external">网易摄影</a>为例子分 Java 和 Python 两种语言爬取图片信息。</p>
<a id="more"></a>
<h3 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h3><p>Java 找了很久找到了 Htmlunit 网络请求库，主要的特点就是模拟浏览器运行。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">//初始化</span></div><div class="line">WebClient wc = <span class="keyword">new</span> WebClient(BrowserVersion.CHROME);</div></pre></td></tr></table></figure>
<p>浏览器种类可更改。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">//相关配置。</span></div><div class="line">wc.getOptions().setUseInsecureSSL(<span class="keyword">true</span>);</div><div class="line">wc.getOptions().setJavaScriptEnabled(<span class="keyword">true</span>); <span class="comment">// 启用JS解释器，默认为true</span></div><div class="line">wc.getOptions().setCssEnabled(<span class="keyword">false</span>); <span class="comment">// 禁用css支持</span></div><div class="line">wc.getOptions().setThrowExceptionOnScriptError(<span class="keyword">false</span>); <span class="comment">// js运行错误时，是否抛出异常</span></div><div class="line">wc.getOptions().setTimeout(<span class="number">100000</span>); <span class="comment">// 设置连接超时时间 ，这里是10S。如果为0，则无限期wc.getOptions().setDoNotTrackEnabled(false);</span></div><div class="line">wc.getOptions().setThrowExceptionOnFailingStatusCode(<span class="keyword">false</span>);</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">HtmlPage page = wc.getPage(&quot;http://pp.163.com/pp/#p=10&amp;c=-1&amp;m=3&amp;page=1&quot;);</div><div class="line">// 该方法在getPage()方法之后调用才能生效</div><div class="line">wc.waitForBackgroundJavaScript(1000 * 3);</div></pre></td></tr></table></figure>
<p>等待网页JS代码运行后我们才能得到我们需要的数据。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* &lt;div class="pic"&gt; &lt;a class="img js-anchor etag noul" hidefocus="true"</span></div><div class="line"><span class="comment">* target="_blank" href="http://pp.163.com/oneness/pp/16356042.html"</span></div><div class="line"><span class="comment">* title="登登与小猫笨笨 "&gt;</span></div><div class="line"><span class="comment">*/</span></div><div class="line"></div><div class="line"><span class="comment">//div[@class="pic"]/a/@href</span></div><div class="line"></div><div class="line">List&lt;DomAttr&gt; links = (List&lt;DomAttr&gt;)page.getByXPath(<span class="string">"//div[@class=\"pic\"]/a/@href"</span>);</div></pre></td></tr></table></figure>
<p>我这里用得是 XPath 进行匹配数据。看下简单的实例，就蛮容易上手的。得到之后，剩下的事情就很简单了。</p>
<p>但是 Htmlunit 进行爬取成功率会有问题，偶尔会有一两次访问不到，不过我暂时没有在 Java 里找到更好的解决方案。</p>
<h3 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h3><p>Python 写这个代码有点早，是用的 Spynner 库，是一个操控一个无 GUI 的 Webkit 核心实现 http访 问的 Python 模块，用来爬使用 js 运行才有结果的网页最好。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line">//初始化</div><div class="line">browser = spynner.Browser()</div><div class="line">browser.create_webview()</div></pre></td></tr></table></figure>
<p>然后调用<br><figure class="highlight python"><table><tr><td class="code"><pre><div class="line">browser.load(url=url, tries=<span class="number">5</span>)</div><div class="line">browser.load_jquery(<span class="keyword">True</span>)</div><div class="line"></div><div class="line">content = browser.html.encode(<span class="string">"utf-8"</span>)</div></pre></td></tr></table></figure></p>
<p>这样 JS 运行后的页面就可以获取到了，通过 bs4 或者 re 正则都可以获取想要的东西。</p>
<p>最后还是放一张图：</p>
<p><img src="http://xcc3641.qiniudn.com/blog75c3c8a451cc91ad59f2f9d2cbd386cf_b.jpg" alt=""></p></div></article></div></section><footer><div class="paginator"></div><div data-thread-key="hide/获取一个有JS加载的网页信息.html" data-title="获取一个有JS加载的网页信息" data-url="http://imxie.cc/hide/获取一个有JS加载的网页信息.html" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"imxie"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = 'http://www.imxie.cc/js/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2014 - 2019 做一件值得的事.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-80145821-1",'auto');ga('send','pageview');</script></body></html>