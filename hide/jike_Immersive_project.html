<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 沉浸式适配个人总结 · IM XIE</title><meta name="description" content="沉浸式适配个人总结 - 谢三弟"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://imxie.cc/atom.xml" title="IM XIE"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/images/logo.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/xcc3641" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">沉浸式适配个人总结</h1><div class="post-info">2016年11月8日</div><div class="post-content"><p>总结适配项目中遇到的沉浸式的坑和个人的解决方案。</p>
<a id="more"></a>
<blockquote>
<ul>
<li>文章来源：itsCoder 的 <a href="https://github.com/itsCoder/weeklyblog" target="_blank" rel="external">WeeklyBolg</a> 项目</li>
<li>itsCoder主页：<a href="http://itscoder.com/" target="_blank" rel="external">http://itscoder.com/</a></li>
<li>作者：<a href="https://github.com/xcc3641" target="_blank" rel="external">谢三弟</a></li>
<li>审阅者：<a href="https://github.com/laobie" target="_blank" rel="external">Jaeger</a></li>
</ul>
</blockquote>
<h3 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h3><ul>
<li><a href="#目录">目录</a></li>
<li><a href="#前言">前言</a></li>
<li><a href="#适配">适配</a><ul>
<li><a href="#标志">标志</a></li>
<li><a href="#布局">布局</a></li>
<li><a href="#修补">修补</a></li>
<li><a href="#坑">坑</a></li>
</ul>
</li>
<li><a href="#源码">源码</a><ul>
<li><a href="#状态栏工具部分核心代码">状态栏工具部分核心代码</a></li>
<li><a href="#环境工具类部分核心代码">环境工具类部分核心代码</a></li>
<li><a href="#修复全屏输入框工具类">修复全屏输入框工具类</a></li>
</ul>
</li>
<li><a href="#总结">总结</a></li>
<li><a href="#参考">参考</a></li>
</ul>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><blockquote>
<p>本篇文章环境是</p>
<ul>
<li>主色调：<strong>白色</strong></li>
<li>右滑返回：<strong>需要</strong></li>
</ul>
</blockquote>
<p>在做沉浸式之前，得知道下面几个问题：</p>
<ol>
<li>什么是沉浸式</li>
<li>Android 系统对沉浸式的支持</li>
</ol>
<p>首先第一个问题，推荐阅读这篇 <a href="http://www.jianshu.com/p/f3683e27fd94" target="_blank" rel="external">Android 沉浸式 UI 实现及原理</a> ，作者对照哔哩哔哩进行分析「个人也认为 B 站在国内 Android 应用里算规范」。</p>
<p>第二个问题，也是个人在适配沉浸式过程中遇到的版本坑，大致总结如下：</p>
<ul>
<li>Android 4.4（19）以下</li>
<li>Android 4.4（19）</li>
<li>「小米 MIUI V4 」和「魅族 Flyme 4.0」以上</li>
<li>Android 5.0 （21）</li>
<li>Android 6.0+（23+）</li>
</ul>
<p>因为 Android 是从 4.4 开始引入 <code>android:windowTranslucentStatus</code> 标签，所以理论上 4.4 以上都可以实现沉浸式，而本方案也是基于 4.4 开始。</p>
<p>因为<strong>即刻</strong>的主色调是<strong>纯白色</strong>，在 Android 里纯白是 BUG 的存在，适配需要做更多对于<strong>状态栏 icon 颜色</strong>的处理。<br>收集资料可以参考：</p>
<ul>
<li><a href="http://www.jianshu.com/p/2756d41e9697" target="_blank" rel="external">Android 状态栏黑色字体</a></li>
<li><a href="http://blog.isming.me/2016/01/09/chang-android-statusbar-text-color/" target="_blank" rel="external">Android 系统更改状态栏字体颜色</a></li>
<li><a href="http://www.jianshu.com/p/7f5a9969be53" target="_blank" rel="external">白底黑字！Android 浅色状态栏黑色字体模式</a></li>
<li><a href="http://open-wiki.flyme.cn/index.php?title=Flyme%E7%B3%BB%E7%BB%9FAPI" target="_blank" rel="external">Flyme 系统 API-沉浸式状态栏</a></li>
</ul>
<p>按照刚才列出的版本，整理注意的细节如图：</p>
<p><img src="http://ww3.sinaimg.cn/large/006y8lVajw1f9jzc1kxcwj31kw0e5n01.jpg" alt=""></p>
<p>关于小米 OS 和魅族 OS 可以参考维基百科：</p>
<ul>
<li><a href="https://zh.wikipedia.org/wiki/Flyme_OS" target="_blank" rel="external">Flyme OS - 维基百科，自由的百科全书</a></li>
<li><a href="https://zh.wikipedia.org/wiki/MIUI" target="_blank" rel="external">MIUI - 维基百科，自由的百科全书</a></li>
</ul>
<h3 id="适配"><a href="#适配" class="headerlink" title="适配"></a>适配</h3><h4 id="标志"><a href="#标志" class="headerlink" title="标志"></a>标志</h4><p>适配中用到的 Flag 有：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">View.SYSTEM_UI_FLAG_LAYOUT_STABLE</div><div class="line">View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN</div><div class="line">View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION</div></pre></td></tr></table></figure>
<p>在 4.4(API 19) 中还引入了 <code>WindowManager.LayoutParams.FLAG_TRANSUCENT_STATUS</code> 和<code>WindowManager.LayoutParams.FLAG_TRANSLUCENT_NAVIGATION</code> 用于控制 <code>System UI</code> 变透明，这两个 Flag 分别对应于 <code>windowTranslucentStatus</code> 和<code>windowTranslucentNavigation</code> 两个 attr，并同时提供了相应的 Theme（这些 Theme 都没有 ActionBar），当使用这两个 Flag 时，<code>SYSTEM_UI_FLAG_LAYOUT_STABLE、SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN和SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION</code> 会被自动添加。</p>
<h4 id="布局"><a href="#布局" class="headerlink" title="布局"></a>布局</h4><p>从 4.4 开始，所以在 style-19 里所有父级主题增加：<br><figure class="highlight xml"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"JikeTheme.SystemUi"</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="xml">	<span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android:windowTranslucentStatus"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></div><div class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>在业务基类 <strong>BaseActivity</strong>  <code>onCreate()</code> 中加入了对沉浸式的一些判断和处理：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">isSuccessStatusIcons = <span class="keyword">true</span>; <span class="comment">// 默认认为可以设置状态栏 Icon 颜色</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">  <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">  StatusBarUtil.setImmersiveStatusBar(<span class="keyword">this</span>);</div><div class="line">  <span class="comment">// 适配状态栏字体颜色</span></div><div class="line">  <span class="keyword">if</span> (needStatusIconsBlack()) &#123;</div><div class="line">    isSuccessStatusIcons = StatusBarUtil.setStatusBarDarkIcon(<span class="keyword">this</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (!isSuccessStatusIcons &amp;&amp; ImmersiveUtil.supportImmersiveStatusBar()) &#123;</div><div class="line">    <span class="keyword">if</span> (needAddColorStatusView()) &#123;</div><div class="line">      StatusBarUtil.addColorStatusView(<span class="keyword">this</span>, R.color.black);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      StatusBarUtil.addTranslucentView(<span class="keyword">this</span>, <span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里有四个方法：</p>
<ul>
<li>StatusBarUtil.setImmersiveStatusBar(this);  // 添加全屏/透明状态栏的 Flag</li>
<li>StatusBarUtil.setStatusBarDarkIcon(this); // 设置状态栏 Icon 为黑色</li>
<li>StatusBarUtil.addColorStatusView(this, R.color.very_dark_grayish_blue_26); // 添加一个带颜色的矩形块</li>
<li>StatusBarUtil.addTranslucentView(this, 0); // 添加一个透明状态栏</li>
</ul>
<p>主要是这里的逻辑需要说明</p>
<blockquote>
<p><code>if (!isSuccessStatusIcons &amp;&amp; StatusBarUtil.supportImmersiveStatusBar())</code></p>
</blockquote>
<p>前面已经说了 5.x 的非小米魅族 Rom 无法更改状态栏 icon 颜色，所以我进行适配的方法是，isSuccessStatusIcons 来标识是不是非（魅族，小米） 的其他 Rom，然后加入一个与状态栏等高的带颜色的矩形 View ，也就是<code>StatusBarUtil.addColorStatusView(this, R.color.very_dark_grayish_blue_26);</code> 方法做的事情，同时通过 <code>needAddColorStatusView()</code>标志是否需要添加。</p>
<p>这样说可能不好理解， 一个具体的场景是这样：</p>
<p><img src="http://ww3.sinaimg.cn/large/006y8lVajw1f9k09xq8k9j30vf0sek07.jpg" alt=""></p>
<p>可以看到，在 5.x 首页状态栏是一个黑条，也就是我们手动加上去的矩形，但在有图片的 activity 是透明，这也就是 <code>needAddColorStatusView</code> 标识的作用。</p>
<p>接下来适配 Toolbar ：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initToolbar</span><span class="params">(@NonNull Toolbar toolbar)</span> </span>&#123;</div><div class="line">  <span class="comment">// other code</span></div><div class="line">  StatusBarUtil.setImmersiveStatusBarToolbar(toolbar, <span class="keyword">this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 统一适配 toolbar</span></div><div class="line"><span class="comment"> * 设置 toolbar 高度为 ?attr/actionBarSize + statusBarHeight 并且设置 padding 布局还原</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setImmersiveStatusBarToolbar</span><span class="params">(Toolbar toolbar, Context context)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (ImmersiveUtil.supportImmersiveStatusBar()) &#123;</div><div class="line">        ViewGroup.MarginLayoutParams toolLayoutParams = (ViewGroup.MarginLayoutParams) toolbar.getLayoutParams();</div><div class="line">        toolLayoutParams.height = EnvUtil.getStatusBarHeight() + EnvUtil.getActionBarSize(context);</div><div class="line">        toolbar.setLayoutParams(toolLayoutParams);</div><div class="line">        setImmersiveStatusToolbarOnlyPadding(toolbar, <span class="number">0</span>, EnvUtil.getStatusBarHeight(), <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>主要做的事情就是，将 Toolbar 的高度增加一个状态栏高度，且设置 paddingTop。</p>
<p>这样在 BaseActivity 里就把状态栏和 Toolbar 都适配好了。</p>
<p>接下来就是给内容详情增加正确的 margin 值。</p>
<p>其实以上大部分都跟具体的界面编写有关，所以这里只提供一个思路。</p>
<h4 id="修补"><a href="#修补" class="headerlink" title="修补"></a>修补</h4><p>适配之后整个页面看着是可行的，但是得额外注意一些具体场景：</p>
<ol>
<li><p>需要输入法</p>
</li>
<li><p>与状态栏有关的遮挡交互动画</p>
</li>
</ol>
<p><strong>第一个</strong> 比较特殊性。为了适配沉浸式，我们使用了<code>View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN</code> 标签，该标签下，adjustResize 会失效，adjustPan 效果很差。为了实现输入法弹出效果，写了一个 FullscreenInputModeUtil 工具类兼容实现，主要逻辑是动态计算可见高度来得到输入法高度，从而改变布局整个高度（输入栏框是始终在布局最底部）实现 adjustResize 效果。</p>
<p>具体可以参考  <a href="https://code.google.com/p/android/issues/detail?id=5497" target="_blank" rel="external">code.google.com</a></p>
<p><strong>第二个</strong> 是这样的：</p>
<p><img src="http://ww3.sinaimg.cn/large/006tNc79gw1f9xpphob6wg30di0o11kx.gif" alt=""></p>
<p>原本是 CoordinatorLayout Behavior 实现 Toolbar 上滑隐藏效果， BUG 是上滑应该隐藏在状态栏后的 Title 并没有消失。<br>所以现有的解决方案是在 layout 里写一个背景是白色高度是0的 View 并在代码里根据 sdk 修改高度：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 增加一个实体白色 View 在状态栏下，复原滑动效果</span></div><div class="line"><span class="keyword">if</span> (ImmersiveUtil.supportImmersiveStatusBar()) &#123;</div><div class="line">  mTrickStatusBar.getLayoutParams().height = EnvUtil.getStatusBarHeight();</div><div class="line">  mTrickStatusBar.requestLayout();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="坑"><a href="#坑" class="headerlink" title="坑"></a>坑</h4><ul>
<li>ROM 坑</li>
</ul>
<p>根据手机厂商判断 Rom 是不行的，因为会有小米手机但是刷了其他 Rom 的情况，所以我们得找到正确判断 Rom 的方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getRomProperty</span><span class="params">(String prop)</span> </span>&#123;</div><div class="line">    String line = <span class="string">""</span>;</div><div class="line">    BufferedReader reader = <span class="keyword">null</span>;</div><div class="line">    Process process = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        process = Runtime.getRuntime().exec(<span class="string">"getprop "</span> + prop);</div><div class="line">        reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(process.getInputStream()), <span class="number">1024</span>);</div><div class="line">        line = reader.readLine();</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        IOUtil.close(reader);</div><div class="line">        <span class="keyword">if</span> (process != <span class="keyword">null</span>) &#123;</div><div class="line">            process.destroy();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> line;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该方法主要是执行命令行，去获取 <strong>build.prop</strong> 文件的信息，里面记录了系统的设置和属性，相当于 Windows 系统注册表的文件。当然包括了该手机使用的 Rom 信息，上层我们只需要判断是否含有特殊适配的 Rom 字段即可。这样就可以准确适配不同手机不同系统。</p>
<ul>
<li>虚拟导航栏是否存在</li>
</ul>
<p>这里大部分的场景是需要输入栏的页面——因为大多输入栏的布局都会是<code>layout_alignParentBottom=true</code>。因为即刻中采取的沉浸式方案是全屏，有输入栏的页面，会设置一个虚拟导航栏的 padding 值，这样才能保证输入栏不会被虚拟导航栏遮挡。</p>
<p><strong>所以这里的关键就是判断该手机是否有虚拟导航栏。</strong></p>
<p>最开始的时候，我们是通过判断是否有硬件按钮（菜单键，返回键），来直接一刀决定是否有虚拟导航栏。但是在 Android 机型复杂的环境下，该方法并不能保证所有适配。所以换了一种方案：</p>
<p>用 Display 来帮助，该类中有个方法：</p>
<blockquote>
<p>Gets display metrics based on the real size of this display.<br>The size is adjusted based on the current rotation of the display.<br>The real size may be smaller than the physical size of the screen when the window manager is emulating a smaller display (using adb shell am display-size).</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> More ...getRealMetrics(DisplayMetrics outMetrics) &#123;</div><div class="line">	<span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">		updateDisplayInfoLocked();</div><div class="line">		mDisplayInfo.getLogicalMetrics(outMetrics,</div><div class="line">		CompatibilityInfo.DEFAULT_COMPATIBILITY_INFO,</div><div class="line">		mDisplayAdjustments.getActivityToken());</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从上诉方法我们可以得到一个近似于手机物理屏幕的尺寸，这里我们认为是 realSize .</p>
<blockquote>
<p>Gets display metrics that describe the size and density of this display.<br>The size is adjusted based on the current rotation of the display.<br>The size returned by this method does not necessarily represent the actual raw size (native resolution) of the display. The returned size may be adjusted to exclude certain system decor elements that are always visible. It may also be scaled to provide compatibility with older applications that were originally designed for smaller displays.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> More ...getMetrics(DisplayMetrics outMetrics) &#123;</div><div class="line">	<span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">		updateDisplayInfoLocked();</div><div class="line">		mDisplayInfo.getAppMetrics(outMetrics, mDisplayAdjustments);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>同时通过该方法获取可见视图的尺寸。接下来的事情，就是分别比较长宽大小来判断是否有导航栏。</p>
<h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><h4 id="状态栏工具部分核心代码"><a href="#状态栏工具部分核心代码" class="headerlink" title="状态栏工具部分核心代码"></a>状态栏工具部分核心代码</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StatusBarUtil</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 透明状态栏 让布局延伸到状态栏</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setImmersiveStatusBar</span><span class="params">(@NonNull Activity activity)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (ImmersiveUtil.supportImmersiveStatusBar()) &#123;</div><div class="line">            <span class="keyword">if</span> (SdkUtil.sdkVersionGe21()) &#123;</div><div class="line">                activity.getWindow().setStatusBarColor(Color.TRANSPARENT);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (SdkUtil.sdkVersionEq(<span class="number">19</span>)) &#123;</div><div class="line">                activity.getWindow().setFlags(WindowManager.LayoutParams.FLAG_TRANSLUCENT_STATUS,</div><div class="line">                        WindowManager.LayoutParams.FLAG_TRANSLUCENT_STATUS);</div><div class="line">            &#125;</div><div class="line">            activity.getWindow()</div><div class="line">                    .getDecorView()</div><div class="line">                    .setSystemUiVisibility(View.SYSTEM_UI_FLAG_LAYOUT_STABLE | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 统一适配 toolbar</span></div><div class="line"><span class="comment">     * 设置 toolbar 高度为 ?attr/actionBarSize + statusBarHeight 并且设置 padding 布局还原</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setImmersiveStatusBarToolbar</span><span class="params">(@NonNull Toolbar toolbar, Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (ImmersiveUtil.supportImmersiveStatusBar()) &#123;</div><div class="line">            ViewGroup.MarginLayoutParams toolLayoutParams = (ViewGroup.MarginLayoutParams) toolbar.getLayoutParams();</div><div class="line">            toolLayoutParams.height = EnvUtil.getStatusBarHeight() + EnvUtil.getActionBarSize(context);</div><div class="line">            toolbar.setLayoutParams(toolLayoutParams);</div><div class="line">            setImmersiveStatusToolbarOnlyPadding(toolbar, <span class="number">0</span>, EnvUtil.getStatusBarHeight(), <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 为沉浸式抽离设置 toolbar padding 值的方法</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setImmersiveStatusToolbarOnlyPadding</span><span class="params">(@NonNull Toolbar toolbar, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (SdkUtil.sdkVersionGe21()) &#123;</div><div class="line">            toolbar.setPadding(left, top, right, bottom);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SdkUtil.sdkVersionGe19()) &#123;</div><div class="line">            toolbar.setPadding(left, top - DensityUtil.dimenPixelSize(R.dimen.shadow_size), right, bottom);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            toolbar.setPadding(left, <span class="number">0</span>, right, bottom);</div><div class="line">        &#125;</div><div class="line">        toolbar.requestLayout();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 给内容页设置正确的 margin 值</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> includeActionBar true： Height = StatusBar + ActionBar false： Height = StatusBar</span></div><div class="line"><span class="comment">     */</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setImmersiveStatusBarContent</span><span class="params">(@NonNull View view, <span class="keyword">boolean</span> includeActionBar)</span> </span>&#123;</div><div class="line"></div><div class="line">        ViewGroup.MarginLayoutParams params = (ViewGroup.MarginLayoutParams) view.getLayoutParams();</div><div class="line">        <span class="keyword">if</span> (ImmersiveUtil.supportImmersiveStatusBar()) &#123;</div><div class="line">            <span class="keyword">if</span> (includeActionBar) &#123;</div><div class="line">                params.topMargin = EnvUtil.getStatusBarHeight() + EnvUtil.getActionBarSize(view.getContext());</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                params.topMargin = EnvUtil.getStatusBarHeight();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (includeActionBar) &#123;</div><div class="line">                params.topMargin = EnvUtil.getActionBarSize(view.getContext()) + DensityUtil.dimenPixelSize(R.dimen.shadow_size) * <span class="number">2</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        view.setLayoutParams(params);</div><div class="line">        view.requestLayout();</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 给需要弹出输入法的页面设置弹出效果和正确的 padding 值</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setImmersiveNeedInputView</span><span class="params">(@NonNull Activity activity, @NonNull ViewGroup viewGroup)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (ImmersiveUtil.supportImmersiveStatusBar()) &#123;</div><div class="line">            FullscreenInputModeUtil.attachActivity(activity, viewGroup);</div><div class="line">            viewGroup.setPadding(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, EnvUtil.getNavigationBarHeight());</div><div class="line">            viewGroup.requestLayout();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 添加颜色矩形条</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addColorStatusView</span><span class="params">(@NonNull Activity activity, @ColorRes <span class="keyword">int</span> color)</span> </span>&#123;</div><div class="line">        ViewGroup contentView =</div><div class="line">                (ViewGroup) activity.findViewById(Window.ID_ANDROID_CONTENT);</div><div class="line">        <span class="keyword">if</span> (contentView.getChildCount() &gt; <span class="number">1</span>) &#123;</div><div class="line">            contentView.getChildAt(<span class="number">1</span>).setBackgroundColor(ContextCompat.getColor(activity, color));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            contentView.addView(createColorStatusBarView(activity, color));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 添加半透明矩形条</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addTranslucentView</span><span class="params">(@NonNull Activity activity, <span class="keyword">int</span> statusBarAlpha)</span> </span>&#123;</div><div class="line">        ViewGroup contentView = (ViewGroup) activity.findViewById(Window.ID_ANDROID_CONTENT);</div><div class="line">        <span class="keyword">if</span> (contentView.getChildCount() &gt; <span class="number">1</span>) &#123;</div><div class="line">            contentView.getChildAt(<span class="number">1</span>).setBackgroundColor(Color.argb(statusBarAlpha, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            contentView.addView(createTranslucentStatusBarView(activity, statusBarAlpha));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 创建半透明矩形 View</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> View <span class="title">createTranslucentStatusBarView</span><span class="params">(@NonNull Activity activity, <span class="keyword">int</span> alpha)</span> </span>&#123;</div><div class="line">        <span class="comment">// 绘制一个和状态栏一样高的矩形</span></div><div class="line">        View statusBarView = <span class="keyword">new</span> View(activity);</div><div class="line">        LinearLayout.LayoutParams params =</div><div class="line">                <span class="keyword">new</span> LinearLayout.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, EnvUtil.getStatusBarHeight());</div><div class="line">        statusBarView.setLayoutParams(params);</div><div class="line">        statusBarView.setBackgroundColor(Color.argb(alpha, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>));</div><div class="line">        <span class="keyword">return</span> statusBarView;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 创建一个带颜色矩形 View</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> View <span class="title">createColorStatusBarView</span><span class="params">(@NonNull Activity activity, @ColorRes <span class="keyword">int</span> color)</span> </span>&#123;</div><div class="line">        <span class="comment">// 绘制一个和状态栏一样高的矩形</span></div><div class="line">        View statusBarView = <span class="keyword">new</span> View(activity);</div><div class="line">        LinearLayout.LayoutParams params =</div><div class="line">                <span class="keyword">new</span> LinearLayout.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, EnvUtil.getStatusBarHeight());</div><div class="line">        statusBarView.setLayoutParams(params);</div><div class="line">        statusBarView.setBackgroundColor(ContextCompat.getColor(activity, color));</div><div class="line">        <span class="keyword">return</span> statusBarView;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> 是否设置颜色成功</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">setStatusBarDarkIcon</span><span class="params">(@NonNull Activity activity)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!ImmersiveUtil.supportImmersiveStatusBar()) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (EnvUtil.isMeizu()) &#123;</div><div class="line">                StatusBarUtil.setMeizuStatusBarDarkIcon(activity, <span class="keyword">true</span>);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (EnvUtil.isXiaomi()) &#123;</div><div class="line">                StatusBarUtil.setMiuiStatusBarDarkIcon(activity, <span class="keyword">true</span>);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (EnvUtil.isZuk()) &#123;</div><div class="line">                <span class="comment">// Zuk 的 rom 无法修改状态栏 icon 颜色</span></div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SdkUtil.sdkVersionGe23()) &#123;</div><div class="line">                activity.getWindow().getDecorView().setSystemUiVisibility(View.SYSTEM_UI_FLAG_LAYOUT_STABLE | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN | View.SYSTEM_UI_FLAG_LIGHT_STATUS_BAR);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 修改魅族状态栏字体颜色 Flyme 4.0</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setMeizuStatusBarDarkIcon</span><span class="params">(@NonNull Activity activity, <span class="keyword">boolean</span> dark)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (ImmersiveUtil.supportImmersiveStatusBar()) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                WindowManager.LayoutParams lp = activity.getWindow().getAttributes();</div><div class="line">                Field darkFlag = WindowManager.LayoutParams.class</div><div class="line">                        .getDeclaredField(<span class="string">"MEIZU_FLAG_DARK_STATUS_BAR_ICON"</span>);</div><div class="line">                Field meizuFlags = WindowManager.LayoutParams.class</div><div class="line">                        .getDeclaredField(<span class="string">"meizuFlags"</span>);</div><div class="line">                darkFlag.setAccessible(<span class="keyword">true</span>);</div><div class="line">                meizuFlags.setAccessible(<span class="keyword">true</span>);</div><div class="line">                <span class="keyword">int</span> bit = darkFlag.getInt(<span class="keyword">null</span>);</div><div class="line">                <span class="keyword">int</span> value = meizuFlags.getInt(lp);</div><div class="line">                <span class="keyword">if</span> (dark) &#123;</div><div class="line">                    value |= bit;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    value &amp;= ~bit;</div><div class="line">                &#125;</div><div class="line">                meizuFlags.setInt(lp, value);</div><div class="line">                activity.getWindow().setAttributes(lp);</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                JLog.e(e, e.toString());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 修改 MIUI V6  以上状态栏颜色</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setMiuiStatusBarDarkIcon</span><span class="params">(@NonNull Activity activity, <span class="keyword">boolean</span> dark)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (ImmersiveUtil.supportImmersiveStatusBar()) &#123;</div><div class="line">            Class&lt;? extends Window&gt; clazz = activity.getWindow().getClass();</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Class&lt;?&gt; layoutParams = Class.forName(<span class="string">"android.view.MiuiWindowManager$LayoutParams"</span>);</div><div class="line">                Field field = layoutParams.getField(<span class="string">"EXTRA_FLAG_STATUS_BAR_DARK_MODE"</span>);</div><div class="line">                <span class="keyword">int</span> darkModeFlag = field.getInt(layoutParams);</div><div class="line">                Method extraFlagField = clazz.getMethod(<span class="string">"setExtraFlags"</span>, <span class="keyword">int</span>.class, <span class="keyword">int</span>.class);</div><div class="line">                extraFlagField.invoke(activity.getWindow(), dark ? darkModeFlag : <span class="number">0</span>, darkModeFlag);</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                JLog.e(e, e.toString());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="环境工具类部分核心代码"><a href="#环境工具类部分核心代码" class="headerlink" title="环境工具类部分核心代码"></a>环境工具类部分核心代码</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnvUtil</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkDeviceHasNavigationBar</span><span class="params">(Activity activity)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (sHasNavigationBar != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        WindowManager windowManager = activity.getWindowManager();</div><div class="line">        Display display = windowManager.getDefaultDisplay();</div><div class="line">        DisplayMetrics realDisplayMetrics = <span class="keyword">new</span> DisplayMetrics();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (SdkUtil.sdkVersionGe(<span class="number">17</span>)) &#123;</div><div class="line">            display.getRealMetrics(realDisplayMetrics);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> realHeight = realDisplayMetrics.heightPixels;</div><div class="line">        <span class="keyword">int</span> realWidth = realDisplayMetrics.widthPixels;</div><div class="line"></div><div class="line">        DisplayMetrics displayMetrics = <span class="keyword">new</span> DisplayMetrics();</div><div class="line">        display.getMetrics(displayMetrics);</div><div class="line"></div><div class="line">        <span class="keyword">int</span> displayHeight = displayMetrics.heightPixels;</div><div class="line">        <span class="keyword">int</span> displayWidth = displayMetrics.widthPixels;</div><div class="line"></div><div class="line">        sHasNavigationBar = (realWidth - displayWidth) &gt; <span class="number">0</span> || (realHeight - displayHeight) &gt; <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isXiaomi</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> MIUI.equalsIgnoreCase(getRomInfo());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isMeizu</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> FLYME.equalsIgnoreCase(getRomInfo());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isZuk</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> ZUK.equalsIgnoreCase(getRomInfo());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String romInfo = <span class="string">""</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MIUI = <span class="string">"miui"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String FLYME = <span class="string">"flyme"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ZUK = <span class="string">"zuk"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String UNKNOWN = <span class="string">"unknown"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String RUNTIME_MIUI = <span class="string">"ro.miui.ui.version.name"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String RUNTIME_DISPLAY = <span class="string">"ro.build.display.id"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String RUNTIME_ZUK = <span class="string">"ro.com.zui.version"</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getRomInfo</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!TextUtils.isEmpty(romInfo)) &#123;</div><div class="line">            <span class="keyword">return</span> romInfo;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!TextUtils.isEmpty(getRomProperty(RUNTIME_MIUI))) &#123;</div><div class="line">            romInfo = MIUI;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!TextUtils.isEmpty(getRomProperty(RUNTIME_ZUK))) &#123;</div><div class="line">            romInfo = ZUK;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getRomProperty(RUNTIME_DISPLAY).toLowerCase().contains(FLYME)) &#123;</div><div class="line">            romInfo = FLYME;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            romInfo = UNKNOWN;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> romInfo;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getRomProperty</span><span class="params">(String prop)</span> </span>&#123;</div><div class="line">        String line = <span class="string">""</span>;</div><div class="line">        BufferedReader reader = <span class="keyword">null</span>;</div><div class="line">        Process process = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            process = Runtime.getRuntime().exec(<span class="string">"getprop "</span> + prop);</div><div class="line">            reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(process.getInputStream()), <span class="number">1024</span>);</div><div class="line">            line = reader.readLine();</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            IOUtil.close(reader);</div><div class="line">            <span class="keyword">if</span> (process != <span class="keyword">null</span>) &#123;</div><div class="line">                process.destroy();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> line;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="修复全屏输入框工具类"><a href="#修复全屏输入框工具类" class="headerlink" title="修复全屏输入框工具类"></a>修复全屏输入框工具类</h4><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FullscreenInputModeUtil</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">attachActivity</span><span class="params">(Activity activity, ViewGroup group)</span> </span>&#123;</div><div class="line">        <span class="keyword">new</span> FullscreenInputModeUtil(activity, group);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">private</span> View mChildOfContent;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> usableHeightPrevious;</div><div class="line">    <span class="keyword">private</span> FrameLayout.LayoutParams mChildLayoutParams;</div><div class="line">    <span class="keyword">private</span> ViewGroup mInputParentView;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">FullscreenInputModeUtil</span><span class="params">(Activity activity, ViewGroup viewGroup)</span> </span>&#123;</div><div class="line">        FrameLayout content = (FrameLayout) activity.findViewById(Window.ID_ANDROID_CONTENT);</div><div class="line">        mInputParentView = viewGroup;</div><div class="line">        mInputParentView.setBackgroundColor(Color.WHITE);</div><div class="line">        mChildOfContent = content.getChildAt(<span class="number">0</span>);</div><div class="line">        mChildOfContent.getViewTreeObserver().addOnGlobalLayoutListener(() -&gt; &#123;</div><div class="line">            <span class="comment">// 当在一个视图树中全局布局发生改变或者视图树中的某个视图的可视状态发生改变时，所要调用的回调函数的接口类</span></div><div class="line">            resizeChildOfContent();</div><div class="line">        &#125;);</div><div class="line">        mChildLayoutParams = (FrameLayout.LayoutParams) mChildOfContent.getLayoutParams();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 重置 content 布局，通过计算可见范围的变化值，确定输入框的高度（兼容一个状态栏高度）</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resizeChildOfContent</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> visibleHeightNow = ViewUtil.getVisibleHeightInLayout(mChildOfContent);</div><div class="line">        <span class="keyword">if</span> (visibleHeightNow != usableHeightPrevious) &#123;</div><div class="line">            <span class="keyword">int</span> visibleHeightSansKeyboard = mChildOfContent.getRootView().getHeight();</div><div class="line">            <span class="keyword">int</span> heightDifference = visibleHeightSansKeyboard - visibleHeightNow;</div><div class="line">            <span class="keyword">if</span> (heightDifference &gt; (visibleHeightSansKeyboard / <span class="number">4</span>)) &#123;</div><div class="line">                <span class="comment">// 输入法出现</span></div><div class="line">                mChildLayoutParams.height = visibleHeightSansKeyboard - heightDifference + EnvUtil.getStatusBarHeight();</div><div class="line">                mInputParentView.setPadding(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// 输入法消失</span></div><div class="line">                mChildLayoutParams.height = visibleHeightSansKeyboard;</div><div class="line">                mInputParentView.setPadding(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, EnvUtil.getNavigationBarHeight());</div><div class="line">            &#125;</div><div class="line">            mChildOfContent.requestLayout();</div><div class="line">            usableHeightPrevious = visibleHeightNow;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>本文主要是提供一个具体可行方案和开发中遇到的一些坑的解决方案提供出来。如果你的应用主色调不是纯白色，那么理论上可以完全适配到 4.4 (19) 。</p>
<p>对于沉浸式，众说纷纭，但是唯一的目的，就是提高用户体验。</p>
<p>如果还有什么遗漏的地方，欢迎补充。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="http://jaeger.itscoder.com/android/2016/02/15/status-bar-demo.html" target="_blank" rel="external">Android App 沉浸式状态栏解决方案</a></li>
<li><a href="http://angeldevil.me/2014/09/02/About-Status-Bar-and-Navigation-Bar/" target="_blank" rel="external">与 Status Bar 和 Navigation Bar 相关的一些东西</a></li>
<li><a href="http://stackoverflow.com/questions/7417123/android-how-to-adjust-layout-in-full-screen-mode-when-softkeyboard-is-visible" target="_blank" rel="external">Android How to adjust layout in Full Screen Mode when softkeyboard is visible</a></li>
</ul></div></article></div></section><footer><div class="paginator"></div><div data-thread-key="hide/jike_Immersive_project.html" data-title="沉浸式适配个人总结" data-url="http://imxie.cc/hide/jike_Immersive_project.html" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"imxie"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = 'http://www.imxie.cc/js/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2014 - 2019 做一件值得的事.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-80145821-1",'auto');ga('send','pageview');</script></body></html>