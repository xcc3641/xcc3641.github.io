<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> RxJava + Retrofit 的实际应用场景 · IM XIE</title><meta name="description" content="RxJava + Retrofit 的实际应用场景 - 谢三弟"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://imxie.cc/atom.xml" title="IM XIE"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/xcc3641" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/WebLab/" target="_self" class="nav-list-link">WEBLAB</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">RxJava + Retrofit 的实际应用场景</h1><div class="post-info">2016年5月24日</div><div class="post-content"><p>关于<code>RxJava Retrofit</code>很多篇文章都有详细的说明，在这里我想分享一个具体的使用案例，在我的开源项目 <a href="https://github.com/xcc3641/SeeWeather" target="_blank" rel="external">就看天气</a> 里的实际应用。也希望跟大家探讨如何优雅的使用。</p>
<a id="more"></a>
<!-- toc -->
<ul>
<li><a href="#前提">前提</a></li>
<li><a href="#实战">实战</a><ul>
<li><a href="#准备">准备</a></li>
<li><a href="#组件">组件</a><ul>
<li><a href="#rxschedulerhelper">RxSchedulerHelper</a></li>
<li><a href="#handleresult">handleResult</a></li>
<li><a href="#retrofitsingleton">RetrofitSingleton</a></li>
</ul>
</li>
<li><a href="#使用">使用</a></li>
</ul>
</li>
<li><a href="#结语">结语</a></li>
</ul>
<!-- tocstop -->
<h2 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h2><p>需要知道什么是 <code>RxJava</code></p>
<p>这里推荐下 扔物线写的 <a href="http://gank.io/post/560e15be2dca930e00da1083" target="_blank" rel="external">给 Android 开发者的 RxJava 详解</a></p>
<p>再感谢 <a href="http://gank.io/post/56e80c2c677659311bed9841" target="_blank" rel="external">RxJava 与 Retrofit 结合的最佳实践</a> 这篇满满的干货。</p>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><p>项目中用到的依赖：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">compile <span class="string">'io.reactivex:rxjava:1.1.0'</span></div><div class="line">compile <span class="string">'io.reactivex:rxandroid:1.1.0'</span></div><div class="line">compile <span class="string">'com.google.code.gson:gson:2.4'</span></div><div class="line">compile <span class="string">'com.squareup.retrofit2:retrofit:2.0.2'</span></div><div class="line">compile <span class="string">'com.squareup.retrofit2:converter-gson:2.0.2'</span></div><div class="line">compile <span class="string">'com.squareup.retrofit2:adapter-rxjava:2.0.2'</span></div><div class="line">compile <span class="string">'com.squareup.okhttp3:okhttp:3.0.1'</span></div><div class="line">compile <span class="string">'com.squareup.okhttp3:logging-interceptor:3.0.1'</span></div><div class="line">compile <span class="string">'com.squareup.okio:okio:1.6.0'</span></div></pre></td></tr></table></figure>
<p>因为要用到网络，所以千万别忘记了这个权限。<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">&lt;uses-permission android:name=<span class="string">"android.permission.INTERNET"</span>/&gt;</div></pre></td></tr></table></figure></p>
<h3 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h3><p>Rx 封装的工具</p>
<p>使用<code>compose</code>操作符</p>
<p><code>compose()</code>里接收一个<code>Transformer</code>对象，<code>Transformer</code>继承自<code>Func1&lt;Observable&lt;T&gt;, Observable&lt;R&gt;&gt;</code>，可以通过它将一种类型的<code>Observable</code>转换成另一种类型的<code>Observable</code>。</p>
<h4 id="RxSchedulerHelper"><a href="#RxSchedulerHelper" class="headerlink" title="RxSchedulerHelper"></a>RxSchedulerHelper</h4><p>封装 Rx 线程相关操作</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">public static &lt;T&gt; Observable.Transformer&lt;T, T&gt; rxSchedulerHelper() &#123;</div><div class="line">    return tObservable -&gt; tObservable.subscribeOn(Schedulers.io())</div><div class="line">        .unsubscribeOn(AndroidSchedulers.mainThread())</div><div class="line">        .observeOn(AndroidSchedulers.mainThread());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="handleResult"><a href="#handleResult" class="headerlink" title="handleResult"></a>handleResult</h4><p>封装 API 请求后统一处理</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Observable.Transformer&lt;Result&lt;T&gt;, T&gt; handleResult() &#123;</div><div class="line">    <span class="keyword">return</span> resultObservable -&gt; resultObservable.flatMap(tResult -&gt; &#123;</div><div class="line">        <span class="keyword">if</span> (tResult.code == <span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">return</span> createData(tResult.data);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> Observable.error(<span class="keyword">new</span> ApiException(tResult.code));</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="RetrofitSingleton"><a href="#RetrofitSingleton" class="headerlink" title="RetrofitSingleton"></a>RetrofitSingleton</h4><p>自己封装了下 <code>Retrofit</code>。可以学习下<a href="https://drakeet.me/retrofit-2-0-okhttp-3-0-config" target="_blank" rel="external">小艾的方式</a>。</p>
<p>自己将请求是写在该类，使用者只需要关心如何处理拿到的数据和相应的 UI 操作。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Observable&lt;Weather&gt; <span class="title">fetchWeather</span><span class="params">(String city)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> apiService.mWeatherAPI(city, C.KEY)</div><div class="line">        .filter(weatherAPI -&gt; weatherAPI.mHeWeatherDataService30s.get(<span class="number">0</span>).status.equals(<span class="string">"ok"</span>))</div><div class="line">        .map(weatherAPI -&gt; weatherAPI.mHeWeatherDataService30s.get(<span class="number">0</span>))</div><div class="line">        .compose(RxUtils.rxSchedulerHelper());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> Observable&lt;VersionAPI&gt; <span class="title">fetchVersion</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> apiService.mVersionAPI(C.API_TOKEN).compose(RxUtils.rxSchedulerHelper());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>将<strong><em>网络拉取</em></strong>和<strong><em>读取缓存</em></strong>用 Rx 结合。<br>这里就要使用 <code>concat</code> 操作符，<a href="http://reactivex.io/documentation/operators/concat.html" target="_blank" rel="external">官方解释</a>.</p>
<p>首先看看获取网络是如何写的：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Observable&lt;Weather&gt; <span class="title">fetchDataByNetWork</span><span class="params">()</span> </span>&#123;</div><div class="line">    String cityName = Util.replaceCity(mSetting.getCityName());</div><div class="line">    <span class="keyword">return</span> RetrofitSingleton.getInstance()</div><div class="line">        .fetchWeather(cityName)</div><div class="line">        .onErrorReturn(throwable -&gt; &#123;</div><div class="line">            PLog.e(throwable.getMessage());</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里的 onErrorReturn 待会儿说。</p>
<p>再来看看读取缓存的代码：<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Observable&lt;Weather&gt; <span class="title">fetchDataByCache</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> Observable.defer(() -&gt; &#123;</div><div class="line">        Weather weather = (Weather) aCache.getAsObject(C.WEATHER_CACHE);</div><div class="line">        <span class="keyword">return</span> Observable.just(weather);</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后我们将他们连接起来：<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</div><div class="line">    Observable.concat(fetchDataByNetWork(), fetchDataByCache())</div><div class="line">        .first(weather -&gt; weather != <span class="keyword">null</span>)</div><div class="line">        .doOnError(throwable -&gt; &#123;</div><div class="line">            mErroImageView.setVisibility(View.VISIBLE);</div><div class="line">            mRecyclerView.setVisibility(View.GONE);</div><div class="line">        &#125;)</div><div class="line">        .doOnNext(weather -&gt; &#123;</div><div class="line">            mErroImageView.setVisibility(View.GONE);</div><div class="line">            mRecyclerView.setVisibility(View.VISIBLE);</div><div class="line">        &#125;)</div><div class="line">        .doOnTerminate(() -&gt; &#123;</div><div class="line">            mRefreshLayout.setRefreshing(<span class="keyword">false</span>);</div><div class="line">            mProgressBar.setVisibility(View.GONE);</div><div class="line">        &#125;)</div><div class="line">        .subscribe(observer);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>concat + first 连接和过滤的操作实现了，网络+缓存的逻辑。</p>
<p>刚刚为什么说要在网络代码那里使用 onErrorReturn 呢？</p>
<p>如果不写，网络发生异常的话，整个流就会直接走 onError ，不会执行到读取缓存的流。</p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>Rx 的各种操作符的不同组合就可以实现不同的效果。本身 Rx 封装已经足够好了，我们加工的时候一定要想到是否破坏了他本身的优雅。</p>
<p>因为 Rx 是一种数据流链式结构的编程思想，我们在封装时应该不能打断其链式结构。</p>
<p>欢迎互相讨论和探讨 :)</p>
<p><img src="http://ww3.sinaimg.cn/large/a17a2d22gw1f46ltvuwx7j21hc0xce81.jpg" alt=""></p></div></article></div></section><footer><div class="paginator"><a href="/2016/05/30/RxJava_for_fresh_learning/" class="prev">上一篇</a><a href="/2016/05/17/algorithm-learning/" class="next">下一篇</a></div><div data-thread-key="2016/05/24/RxJava-Retrofit-的实际应用场景/" data-title="RxJava + Retrofit 的实际应用场景" data-url="http://imxie.cc/2016/05/24/RxJava-Retrofit-的实际应用场景/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"imxie"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = 'http://www.imxie.cc/js/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2014 - 2019 做一件值得的事.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-80145821-1",'auto');ga('send','pageview');</script></body></html>