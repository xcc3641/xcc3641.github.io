<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 从 RxBus 这辆兰博基尼深入进去 · IM XIE</title><meta name="description" content="从 RxBus 这辆兰博基尼深入进去 - 谢三弟"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://imxie.cc/atom.xml" title="IM XIE"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/xcc3641" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/WebLab/" target="_self" class="nav-list-link">WEBLAB</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">从 RxBus 这辆兰博基尼深入进去</h1><div class="post-info">2016年6月2日</div><div class="post-content"><p>很早之前有看过别人实现的 RxBus , 当初也只是随意用用而已，没有想过去研究。今天看到 brucezz 天哥在群里分享了一把，自己也加入了讨论，下来还实践了一把，所以想借此篇进入到源码层，深刻体验下 RxBus 这辆 “兰博基尼” 的设计美感和独特魅力。</p>
<p><strong>本篇文章已授权微信公众号 guolin_blog （郭霖）独家发布</strong></p>
<a id="more"></a>
<ul>
<li><a href="#Rxbus">RxBus</a><ul>
<li><a href="#准备">准备</a></li>
<li><a href="#解剖">解剖</a></li>
</ul>
</li>
<li><a href="#从-Subject-开始发车">从 Subject 开始发车</a><ul>
<li><a href="#官方解释">官方解释</a></li>
<li><a href="#Subject-源码">Subject 源码</a></li>
<li><a href="#PublishSubject-解释">PublishSubject 解释</a></li>
<li><a href="#串行化">串行化</a></li>
<li><a href="#SerializedSubject">SerializedSubject</a></li>
<li><a href="#SerializedObserver">SerializedObserver</a></li>
<li><a href="#NotificationLite">NotificationLite</a></li>
<li><a href="#CompositeSubscription">CompositeSubscription</a></li>
<li><a href="#参考文章">参考文章</a></li>
</ul>
</li>
<li><a href="#熄火休息">熄火休息</a></li>
</ul>
<h3 id="RxBus"><a href="#RxBus" class="headerlink" title="RxBus"></a>RxBus</h3><h4 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h4><p>关于简单的实现和用法，这篇文章已经很好的说明了。</p>
<p>推荐先看看 RxBus 的简单实现和用法。</p>
<p>地址在这里：<a href="http://brucezz.github.io/articles/2016/06/02/a-simple-rxbus-implementation/" target="_blank" rel="external">RxBus 的简单实现</a></p>
<h4 id="解剖"><a href="#解剖" class="headerlink" title="解剖"></a>解剖</h4><p><img src="http://ww3.sinaimg.cn/large/a17a2d22gw1f4h6davxw6j20m80gotbq.jpg" alt=""></p>
<hr>
<p>让我们看看这辆车到底用了些什么？</p>
<ul>
<li><p>Subject</p>
</li>
<li><p>SerializedSubject</p>
</li>
<li><p>PublishSubject</p>
</li>
<li><p>CompositeSubscription</p>
</li>
</ul>
<h3 id="从-Subject-开始发车"><a href="#从-Subject-开始发车" class="headerlink" title="从 Subject 开始发车"></a>从 Subject 开始发车</h3><h4 id="官方解释"><a href="#官方解释" class="headerlink" title="官方解释"></a>官方解释</h4><p>这是 Subject 的中文解释：</p>
<p>Subject可以看成是一个桥梁或者代理，在某些ReactiveX实现中（如RxJava），它同时充当了Observer和Observable的角色。因为它是一个Observer，它可以订阅一个或多个Observable；又因为它是一个Observable，它可以转发它收到(Observe)的数据，也可以发射新的数据。</p>
<p>由于一个Subject订阅一个Observable，它可以触发这个Observable开始发射数据（如果那个Observable是”冷”的–就是说，它等待有订阅才开始发射数据）。因此有这样的效果，Subject可以把原来那个”冷”的Observable变成”热”的。</p>
<h4 id="Subject-源码"><a href="#Subject-源码" class="headerlink" title="Subject 源码"></a>Subject 源码</h4><p>源码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Subject</span>&lt;<span class="title">T</span>, <span class="title">R</span>&gt; <span class="keyword">extends</span> <span class="title">Observable</span>&lt;<span class="title">R</span>&gt; <span class="keyword">implements</span> <span class="title">Observer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">Subject</span><span class="params">(OnSubscribe&lt;R&gt; onSubscribe)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(onSubscribe);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">hasObservers</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> SerializedSubject&lt;T, R&gt; <span class="title">toSerialized</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (getClass() == SerializedSubject.class) &#123;</div><div class="line">            <span class="keyword">return</span> (SerializedSubject&lt;T, R&gt;)<span class="keyword">this</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SerializedSubject&lt;T, R&gt;(<span class="keyword">this</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>Subject 只有两个方法。</p>
<p><code>hasObservers()</code>方法的解释是:</p>
<blockquote>
<p>Indicates whether the {@link Subject} has {@link Observer Observers} subscribed to it.<br>判断 Subject 是否已经有 observers 订阅了 有则返回 ture</p>
</blockquote>
<p><code>toSerialized()</code> 方法的解释是：</p>
<blockquote>
<p>Wraps a {@link Subject} so that it is safe to call its various {@code on} methods from different threads.<br>包装 Subject 后让它可以安全的在不同线程中调用各种方法</p>
</blockquote>
<p><strong>为什么这个方法后就可以是线程安全了呢？</strong></p>
<p>我们看到 <code>toSerialized()</code> 返回了 <code>SerializedSubject&lt;T, R&gt;</code> 。我们先到这里打住，稍后我们再看看该类做了什么。</p>
<h4 id="PublishSubject-解释"><a href="#PublishSubject-解释" class="headerlink" title="PublishSubject 解释"></a>PublishSubject 解释</h4><p><img src="http://ww4.sinaimg.cn/large/a17a2d22gw1f4h8xwycjdj20ye0k2q5b.jpg" alt=""></p>
<p>在 RxJava 里有一个抽象类 Subject，既是 Observable 又是 Observer，可以把 Subject 理解成一个管道或者转发器，数据从一端输入，然后从另一端输出。</p>
<p>Subject 有好几种，这里可以使用最简单的 <code>PublishSubject</code>。订阅之后，一旦数据从一端传入，结果会里立刻从另一端输出。</p>
<p>源码里给了用法例子：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">PublishSubject&lt;Object&gt; subject = PublishSubject.create();</div><div class="line"><span class="comment">// observer1 will receive all onNext and onCompleted events</span></div><div class="line">subject.subscribe(observer1);</div><div class="line">subject.onNext(<span class="string">"one"</span>);</div><div class="line">subject.onNext(<span class="string">"two"</span>);</div><div class="line"><span class="comment">// observer2 will only receive "three" and onCompleted</span></div><div class="line">subject.subscribe(observer2);</div><div class="line">subject.onNext(<span class="string">"three"</span>);</div><div class="line">subject.onCompleted();</div></pre></td></tr></table></figure>
<h4 id="串行化"><a href="#串行化" class="headerlink" title="串行化"></a>串行化</h4><p>官方文档推荐我们：</p>
<blockquote>
<p>如果你把 Subject 当作一个 Subscriber 使用，注意不要从多个线程中调用它的onNext方法（包括其它的on系列方法），这可能导致同时（非顺序）调用，这会违反Observable协议，给Subject的结果增加了不确定性。</p>
<p>要避免此类问题，你可以将 Subject 转换为一个 SerializedSubject ，类似于这样：<br><figure class="highlight java"><table><tr><td class="code"><pre><div class="line">mySafeSubject = <span class="keyword">new</span> SerializedSubject( myUnsafeSubject );</div></pre></td></tr></table></figure></p>
</blockquote>
<p>所以我们可以看到在 RxBus 初始化的时候我们做了这样一件事情：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Subject&lt;Object, Object&gt; BUS;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="title">RxBus</span><span class="params">()</span> </span>&#123;</div><div class="line">    BUS = <span class="keyword">new</span> SerializedSubject&lt;&gt;(PublishSubject.create());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>为了保证多线程的调用中结果的确定性，我们按照官方推荐将 Subject 转换成了一个 SerializedSubject 。</p>
<h4 id="SerializedSubject"><a href="#SerializedSubject" class="headerlink" title="SerializedSubject"></a>SerializedSubject</h4><p><img src="http://ww4.sinaimg.cn/large/a17a2d22gw1f4i5h2l0anj20ww0nujuy.jpg" alt=""></p>
<p>该类同样是 <code>Subject</code> 的子类，这里贴出该类的构造方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> SerializedObserver&lt;T&gt; observer;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Subject&lt;T, R&gt; actual;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">SerializedSubject</span><span class="params">(<span class="keyword">final</span> Subject&lt;T, R&gt; actual)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(<span class="keyword">new</span> OnSubscribe&lt;R&gt;() &#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> R&gt; child)</span> </span>&#123;</div><div class="line">            actual.unsafeSubscribe(child);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">this</span>.actual = actual;</div><div class="line">    <span class="keyword">this</span>.observer = <span class="keyword">new</span> SerializedObserver&lt;T&gt;(actual);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们发现，<code>Subject</code> 最后转化成了 <code>SerializedObserver</code>.</p>
<h4 id="SerializedObserver"><a href="#SerializedObserver" class="headerlink" title="SerializedObserver"></a>SerializedObserver</h4><blockquote>
<p>When multiple threads are emitting and/or notifying they will be serialized by:<br>Allowing only one thread at a time to emit<br>Adding notifications to a queue if another thread is already emitting<br>Not holding any locks or blocking any threads while emitting</p>
<p>一次只会允许一个线程进行发送事物<br>如果其他线程已经准备就绪，会通知给队列<br>在发送事物中，不会持有任何锁和阻塞任何线程</p>
</blockquote>
<p><img src="http://ww1.sinaimg.cn/large/a17a2d22gw1f4i6cogy7ej20yo0r6gpa.jpg" alt=""></p>
<p>通过介绍可以知道是通过 <code>notifications</code> 来进行并发处理的。</p>
<p>SerializedObserver 类中<br><code>private final NotificationLite&lt;T&gt; nl = NotificationLite.instance();</code></p>
<p>重点看看 nl 在 onNext() 方法里的使用：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span> </span>&#123;</div><div class="line">  <span class="comment">// 省略一些代码</span></div><div class="line">       <span class="keyword">for</span> (;;) &#123;</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MAX_DRAIN_ITERATION; i++) &#123;</div><div class="line">               FastList list;</div><div class="line">               <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">                   list = queue;</div><div class="line">                   <span class="keyword">if</span> (list == <span class="keyword">null</span>) &#123;</div><div class="line">                       emitting = <span class="keyword">false</span>;</div><div class="line">                       <span class="keyword">return</span>;</div><div class="line">                   &#125;</div><div class="line">                   queue = <span class="keyword">null</span>;</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">for</span> (Object o : list.array) &#123;</div><div class="line">                   <span class="keyword">if</span> (o == <span class="keyword">null</span>) &#123;</div><div class="line">                       <span class="keyword">break</span>;</div><div class="line">                   &#125;</div><div class="line">                   <span class="comment">// 这里的 accept() 方法</span></div><div class="line">                   <span class="keyword">try</span> &#123;</div><div class="line">                       <span class="keyword">if</span> (nl.accept(actual, o)) &#123;</div><div class="line">                           terminated = <span class="keyword">true</span>;</div><div class="line">                           <span class="keyword">return</span>;</div><div class="line">                       &#125;</div><div class="line">                   &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">                       terminated = <span class="keyword">true</span>;</div><div class="line">                       Exceptions.throwIfFatal(e);</div><div class="line">                       actual.onError(OnErrorThrowable.addValueAsLastCause(e, t));</div><div class="line">                       <span class="keyword">return</span>;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h4 id="NotificationLite"><a href="#NotificationLite" class="headerlink" title="NotificationLite"></a>NotificationLite</h4><p>知道哪里具体调用了之后，我们再仔细看看  <code>NotificationLite</code> 。</p>
<p>先来了解它到底是什么：</p>
<blockquote>
<p>For use in internal operators that need something like materialize and dematerialize wholly within the implementation of the operator but don’t want to incur the allocation cost of actually creating {@link rx.Notification} objects for every {@link Observer#onNext onNext} and {@link Observer#onCompleted onCompleted}.<br>It’s implemented as a singleton to maintain some semblance of type safety that is completely non-existent.</p>
<p>大致意思是：作为一个单例类保持这种完全不存在的安全类型的表象。  </p>
</blockquote>
<p><img src="http://ww4.sinaimg.cn/large/a17a2d22gw1f4i7btoa64j21ei0qygs6.jpg" alt=""></p>
<p>刚我们在 SerializedObserver 的 onNext() 方法中看到 <code>nl.accept(actual, o)</code><br>所以我们再深入到 <code>accept()</code> 方法中：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(Observer&lt;? <span class="keyword">super</span> T&gt; o, Object n)</span> </span>&#123;</div><div class="line">     <span class="keyword">if</span> (n == ON_COMPLETED_SENTINEL) &#123;</div><div class="line">         o.onCompleted();</div><div class="line">         <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (n == ON_NEXT_NULL_SENTINEL) &#123;</div><div class="line">         o.onNext(<span class="keyword">null</span>);</div><div class="line">         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (n != <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="keyword">if</span> (n.getClass() == OnErrorSentinel.class) &#123;</div><div class="line">             o.onError(((OnErrorSentinel) n).e);</div><div class="line">             <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">         &#125;</div><div class="line">         o.onNext((T) n);</div><div class="line">         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"The lite notification can not be null"</span>);</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Unwraps the lite notification and calls the appropriate method on the {@link Observer}.<br>判断 lite 通知类别，通知 observer 执行适当方法。</p>
</blockquote>
<p>通过 NotificationLite 类图可以看到有三个标识</p>
<ul>
<li>ON_NEXT_NULL_SENTINEL （onNext 标识）</li>
<li>ON_COMPLETED_SENTINEL （onCompleted 标识)</li>
<li>OnErrorSentinel (onError 标识)</li>
</ul>
<p>与 Observer 回调一致。通过分析得知 <code>accept()</code>  就是通过标识来判断，然后调用 Observer 相对应的方法。</p>
<h4 id="CompositeSubscription"><a href="#CompositeSubscription" class="headerlink" title="CompositeSubscription"></a>CompositeSubscription</h4><p>RxBus 这辆”兰博基尼”与 CompositeSubscription 车间搭配更好。</p>
<hr>
<p><img src="http://ww4.sinaimg.cn/large/a17a2d22gw1f4ijb9l4zwj20v80ps42f.jpg" alt=""></p>
<p>构造函数：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> Set&lt;Subscription&gt; subscriptions;</div><div class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> unsubscribed;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">CompositeSubscription</span><span class="params">()</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">CompositeSubscription</span><span class="params">(<span class="keyword">final</span> Subscription... subscriptions)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.subscriptions = <span class="keyword">new</span> HashSet&lt;Subscription&gt;(Arrays.asList(subscriptions));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>内部是初始化了一个 HashSet ，按照哈希算法来存取集合中的对象，存取速度比较快，并且没有重复对象。</p>
<p>所以我们推荐在基类里实例化一个 CompositeSubscription 对象，使用 CompositeSubscription 来持有所有的 Subscriptions ，然后在 onDestroy()或者 onDestroyView()里取消所有的订阅。</p>
<h4 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h4><ul>
<li><a href="http://blog.csdn.net/lzyzsd/article/details/45033611" target="_blank" rel="external">http://blog.csdn.net/lzyzsd/article/details/45033611</a></li>
<li><a href="https://mcxiaoke.gitbooks.io/rxdocs/content/Subject.html" target="_blank" rel="external">https://mcxiaoke.gitbooks.io/rxdocs/content/Subject.html</a></li>
</ul>
<h3 id="熄火休息"><a href="#熄火休息" class="headerlink" title="熄火休息"></a>熄火休息</h3><p>能力有限，文章错误还望指出，有任何问题都欢迎讨论 :)</p>
<p>转载请注明出处。</p>
<p>最后送上我女神 Gakki , 开心最好 ( ´͈ｖ `͈ )◞。</p>
<p><img src="http://ww3.sinaimg.cn/large/a17a2d22gw1f4ijpqofquj20fi0gowgo.jpg" alt=""></p></div></article></div></section><footer><div class="paginator"><a href="/2016/07/04/Sketch-learning-as-android/" class="prev">上一篇</a><a href="/2016/06/02/【转】RxBus-的简单实现/" class="next">下一篇</a></div><div data-thread-key="2016/06/02/deep-understanding-of-RxBus/" data-title="从 RxBus 这辆兰博基尼深入进去" data-url="http://imxie.cc/2016/06/02/deep-understanding-of-RxBus/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"imxie"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = 'http://www.imxie.cc/js/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2014 - 2019 做一件值得的事.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-80145821-1",'auto');ga('send','pageview');</script></body></html>